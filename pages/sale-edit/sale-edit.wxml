<!--pages/sale-edit/sale-edit.wxml-->
<view class="container">
  <!-- 原始数据参考区域 -->
  <view class="reference-section">
    <view class="reference-header">
      <text class="reference-title">原始数据参考</text>
      <text class="reference-subtitle">修改前的销售单信息</text>
    </view>
    <view class="reference-content">
      <view class="reference-item">
        <text class="reference-label">订单号：</text>
        <text class="reference-value">{{originalData.orderNo}}</text>
      </view>
      <view class="reference-item">
        <text class="reference-label">客户：</text>
        <text class="reference-value">{{originalData.customer}}</text>
      </view>
      <view class="reference-item">
        <text class="reference-label">金额：</text>
        <text class="reference-value price">¥{{originalData.totalAmount}}</text>
      </view>
      <view class="reference-item">
        <text class="reference-label">状态：</text>
        <text class="reference-value status">{{originalData.status === 'completed' ? '已完成' : originalData.status === 'pending' ? '待处理' : '已取消'}}</text>
      </view>
    </view>
  </view>

  <!-- 编辑表单 -->
  <scroll-view class="form-container" scroll-y="true">
    <!-- 基本信息 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-title">基本信息</text>
      </view>
      
      <view class="form-group">
        <view class="form-label required">订单号</view>
        <input 
          class="form-input {{errors.orderNo ? 'error' : ''}}" 
          placeholder="请输入订单号" 
          value="{{formData.orderNo}}"
          data-field="orderNo"
          bindinput="onFormInput"
          maxlength="20"
        />
        <text class="error-text" wx:if="{{errors.orderNo}}">{{errors.orderNo}}</text>
      </view>

      <view class="form-group">
        <view class="form-label required">客户姓名</view>
        <input 
          class="form-input {{errors.customer ? 'error' : ''}}" 
          placeholder="请输入客户姓名" 
          value="{{formData.customer}}"
          data-field="customer"
          bindinput="onFormInput"
          maxlength="20"
        />
        <text class="error-text" wx:if="{{errors.customer}}">{{errors.customer}}</text>
      </view>

      <view class="form-group">
        <view class="form-label required">联系电话</view>
        <input 
          class="form-input {{errors.phone ? 'error' : ''}}" 
          placeholder="请输入联系电话" 
          value="{{formData.phone}}"
          data-field="phone"
          bindinput="onFormInput"
          type="number"
          maxlength="11"
        />
        <text class="error-text" wx:if="{{errors.phone}}">{{errors.phone}}</text>
      </view>

      <view class="form-row">
        <view class="form-group half">
          <view class="form-label required">订单状态</view>
          <picker 
            class="form-picker {{errors.status ? 'error' : ''}}"
            mode="selector"
            range="{{statusOptions}}"
            range-key="label"
            value="{{statusIndex}}"
            bindchange="onStatusChange"
          >
            <view class="picker-display">
              {{statusOptions[statusIndex].label}}
            </view>
          </picker>
          <text class="error-text" wx:if="{{errors.status}}">{{errors.status}}</text>
        </view>

        <view class="form-group half">
          <view class="form-label required">支付方式</view>
          <picker 
            class="form-picker {{errors.paymentMethod ? 'error' : ''}}"
            mode="selector"
            range="{{paymentOptions}}"
            value="{{paymentIndex}}"
            bindchange="onPaymentChange"
          >
            <view class="picker-display">
              {{paymentOptions[paymentIndex]}}
            </view>
          </picker>
          <text class="error-text" wx:if="{{errors.paymentMethod}}">{{errors.paymentMethod}}</text>
        </view>
      </view>
    </view>

    <!-- 商品列表 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-title">商品列表</text>
        <view class="section-action" bindtap="showAddItemModal">
          <text class="action-icon">+</text>
          <text class="action-text">添加商品</text>
        </view>
      </view>
      
      <view wx:if="{{formData.items.length > 0}}" class="items-list">
        <view wx:for="{{formData.items}}" wx:key="id" class="item-card">
          <view class="item-header">
            <text class="item-name">{{item.productName}}</text>
            <view class="item-actions">
              <view class="item-action edit" data-index="{{index}}" bindtap="editItem">
                <linear-icon type="edit" size="small" weight="medium" color="primary"></linear-icon>
              </view>
              <view class="item-action delete" data-index="{{index}}" bindtap="deleteItem">
                <linear-icon type="delete" size="small" weight="medium" color="danger"></linear-icon>
              </view>
            </view>
          </view>
          <view class="item-details">
            <view class="item-detail">
              <text class="detail-label">数量：</text>
              <text class="detail-value">{{item.quantity}}</text>
            </view>
            <view class="item-detail">
              <text class="detail-label">单价：</text>
              <text class="detail-value price">¥{{item.price}}</text>
            </view>
            <view class="item-detail">
              <text class="detail-label">小计：</text>
              <text class="detail-value amount">¥{{item.amount}}</text>
            </view>
          </view>
        </view>
      </view>

      <view wx:else class="empty-items">
        <linear-icon type="package" size="large" weight="medium" color="muted"></linear-icon>
        <text class="empty-text">暂无商品，点击上方按钮添加</text>
      </view>

      <text class="error-text" wx:if="{{errors.items}}">{{errors.items}}</text>
    </view>

    <!-- 金额信息 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-title">金额信息</text>
      </view>
      
      <view class="amount-display">
        <view class="amount-item total">
          <text class="amount-label">总金额</text>
          <text class="amount-value">¥{{formData.totalAmount}}</text>
        </view>
      </view>

      <view class="form-group">
        <view class="form-label">手动调整金额</view>
        <input 
          class="form-input price-input {{errors.totalAmount ? 'error' : ''}}" 
          placeholder="0.00" 
          value="{{formData.totalAmount}}"
          data-field="totalAmount"
          bindinput="onFormInput"
          type="digit"
        />
        <text class="form-hint">如需手动调整总金额，请在此输入</text>
        <text class="error-text" wx:if="{{errors.totalAmount}}">{{errors.totalAmount}}</text>
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-header">
        <text class="section-title">备注信息</text>
      </view>
      
      <view class="form-group">
        <textarea 
          class="form-textarea" 
          placeholder="请输入备注信息..." 
          value="{{formData.remark}}"
          data-field="remark"
          bindinput="onFormInput"
          maxlength="200"
          show-confirm-bar="false"
        />
        <view class="textarea-counter">{{formData.remark.length}}/200</view>
      </view>
    </view>

    <!-- 底部安全区域 -->
    <view class="bottom-safe-area"></view>
  </scroll-view>

  <!-- 固定底部操作栏 -->
  <view class="bottom-actions">
    <view class="action-buttons">
      <button class="action-btn secondary" bindtap="cancelEdit">取消</button>
      <button class="action-btn tertiary" bindtap="resetForm">重置</button>
      <button class="action-btn primary {{submitting ? 'loading' : ''}}" bindtap="saveSale" disabled="{{submitting}}">
        {{submitting ? '保存中...' : '保存'}}
      </button>
    </view>
  </view>

  <!-- 添加/编辑商品弹窗 -->
  <view class="modal-overlay {{showAddItem ? 'show' : ''}}" bindtap="hideAddItemModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">{{editingIndex !== undefined ? '编辑商品' : '添加商品'}}</text>
        <view class="modal-close" bindtap="hideAddItemModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <view class="form-label required">商品名称</view>
          <input 
            class="form-input {{itemErrors.productName ? 'error' : ''}}" 
            placeholder="请输入商品名称" 
            value="{{newItem.productName}}"
            data-field="productName"
            bindinput="onItemInput"
            maxlength="50"
          />
          <text class="error-text" wx:if="{{itemErrors.productName}}">{{itemErrors.productName}}</text>
        </view>

        <view class="form-row">
          <view class="form-group half">
            <view class="form-label required">数量</view>
            <input 
              class="form-input {{itemErrors.quantity ? 'error' : ''}}" 
              placeholder="1" 
              value="{{newItem.quantity}}"
              data-field="quantity"
              bindinput="onItemInput"
              type="number"
            />
            <text class="error-text" wx:if="{{itemErrors.quantity}}">{{itemErrors.quantity}}</text>
          </view>

          <view class="form-group half">
            <view class="form-label required">单价 (¥)</view>
            <input 
              class="form-input price-input {{itemErrors.price ? 'error' : ''}}" 
              placeholder="0.00" 
              value="{{newItem.price}}"
              data-field="price"
              bindinput="onItemInput"
              type="digit"
            />
            <text class="error-text" wx:if="{{itemErrors.price}}">{{itemErrors.price}}</text>
          </view>
        </view>

        <view class="amount-preview">
          <text class="preview-label">小计：</text>
          <text class="preview-value">¥{{newItem.amount}}</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn secondary" bindtap="hideAddItemModal">取消</button>
        <button class="modal-btn primary" bindtap="{{editingIndex !== undefined ? 'updateItem' : 'addItemToList'}}">
          {{editingIndex !== undefined ? '更新' : '添加'}}
        </button>
      </view>
    </view>
  </view>
</view>